name: Blue-Green Deployment

# ì–¸ì œ ì‹¤í–‰í• ì§€ (main ë¸Œëžœì¹˜ì— í‘¸ì‹œí•˜ë©´ ì‹¤í–‰)
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ì‹¤í–‰í•  ìž‘ì—…ë“¤
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ë‹¨ê³„: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      # 2ë‹¨ê³„: Java 17 ì„¤ì •
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3ë‹¨ê³„: Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: ðŸ“¦ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4ë‹¨ê³„: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: ðŸ”‘ Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5ë‹¨ê³„: ìŠ¤í”„ë§ ë¶€íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      - name: ðŸ—ï¸ Build Spring Boot Application
        run: ./gradlew clean build

      # 6ë‹¨ê³„: ë¹Œë“œ ê²°ê³¼ í™•ì¸
      - name: ðŸ“‹ List build artifacts
        run: ls -la build/libs/

      # 7ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: ðŸ³ Build Docker Image
        run: |
          # ì»¤ë°‹ í•´ì‹œë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=${COMMIT_SHA:0:7}
          
          echo "Building Docker image with tag: blue-green-demo:$SHORT_SHA"
          docker build -t blue-green-demo:$SHORT_SHA .
          docker tag blue-green-demo:$SHORT_SHA blue-green-demo:latest

      # 8ë‹¨ê³„: Docker ì´ë¯¸ì§€ í™•ì¸
      - name: ðŸ“Š Verify Docker Image
        run: |
          echo "Docker images:"
          docker images | grep blue-green-demo
          
          echo "Testing Docker image:"
          docker run --rm -d --name test-container -p 9999:8080 \
            -e APP_VERSION=test \
            -e APP_ENVIRONMENT=ci \
            blue-green-demo:latest
          
          # ì»¨í…Œì´ë„ˆê°€ ì‹œìž‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬
          curl -f http://localhost:9999/health || exit 1
          
          # í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker stop test-container

      # 9ë‹¨ê³„: ì‹œë®¬ë ˆì´ì…˜ëœ Blue-Green ë°°í¬
      - name: ðŸ”„ Simulate Blue-Green Deployment
        run: |
          echo "=== Blue-Green ë°°í¬ ì‹œë®¬ë ˆì´ì…˜ ==="
          
          # Blue í™˜ê²½ ì‹œìž‘
          echo "Starting Blue environment..."
          docker run -d --name blue-env -p 8081:8080 \
            -e APP_VERSION=1.0 \
            -e APP_ENVIRONMENT=blue \
            blue-green-demo:latest
          
          # Green í™˜ê²½ ì‹œìž‘  
          echo "Starting Green environment..."
          docker run -d --name green-env -p 8082:8080 \
            -e APP_VERSION=2.0 \
            -e APP_ENVIRONMENT=green \
            blue-green-demo:latest
          
          # í™˜ê²½ë“¤ì´ ì‹œìž‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬
          echo "Health checking Blue environment:"
          curl http://localhost:8081/health
          
          echo "Health checking Green environment:"
          curl http://localhost:8082/health
          
          echo "âœ… Blue-Green environments are ready!"

      # 10ë‹¨ê³„: ì •ë¦¬
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "Cleaning up containers..."
          docker stop $(docker ps -q) 2>/dev/null || true
          docker rm $(docker ps -aq) 2>/dev/null || true